/* 08. Signed distance experiments */
load "medit"
load "distance"
load "iovtk"
load "mmg"

/* Create background mesh */
real fac = 3.0;
border left(t=0.0,1.0){ x=-1.0; y=1.0-t; label=0; };
border bot(t=0.0,2.0){ x=-1.0+t; y=0.0; label=0; };
border right(t=0.0,1.0){ x=1.0; y=t; label=0; };
border top(t=0.0,2.0){ x=1.0-t; y=1.0; label=0; };
mesh Th = buildmesh(left(30*fac)+bot(60*fac)+right(30*fac)+top(60*fac));

mesh Th2; /* Th mesh after remeshing it near phi=0 */
mesh Th3; /* Inner part of Th2*/
meshL ThLInt; /* Boundary phi=0 of Th2 */

/* Finite Element spaces */
fespace Vh(Th,P1);
fespace Vh0(Th,P0);
include "tools.idp"

/* Variables definition */
Vh phi, phio, /*Test function for a velocity component:*/ v;
Vh /*Velocity components:*/ g;

/* Initialization of the Level Set function */
func real initialGuess() {
  real x0 = 0, y0 = 0.5, lx = 0.4, ly = 0.4, p = 2, ls;
  ls = ((abs((x-x0)/lx)^p+abs((y-y0)/ly)^p)) - 0.5^p;
  return(ls);
}
phio = initialGuess();

string sout = "08_phio.vtu";
savevtk(sout, Th, phio, dataname="LevelSet");

distance(Th,phio,phi[]);

sout = "08_phi.vtu";
savevtk(sout, Th, phi, dataname="LevelSet");

/* Regularization of shape derivative */
real meshsiz = 1/(30*fac);
real alpha   = 2.0*meshsiz;
real beta    = 8.0*meshsiz;

int [int] lsLabel(1);
lsLabel[0] = 10;

real rInner, rOuter;
rOuter = 2;
rInner = 3;

macro updateBoundary() {
  Th2 = mmg2d(Th, iso = 1, ls = 0.0, metric = phi[], hmax = 0.05);
  Th3 = trunc(Th2, region == rInner);
  ThLInt = extract(Th3,label = lsLabel);
} //

updateBoundary;

real p = 4, dmax = 0.5;
macro J() ((int2d(Th3)((-phi)^p))^(1/p) - dmax/2) // EOM

real Jo = J + dmax/2;

Vh nablaPhix, nablaPhiy, w;
Vh0 LaplPhi;

problem gradxPhi(nablaPhix,v) = int2d(Th)(nablaPhix*v + alpha^2*(dx(nablaPhix)*dx(v)+dy(nablaPhix)*dy(v)))
                        -int2d(Th)(dx(phi)*v);

problem gradyPhi(nablaPhiy,v) = int2d(Th)(nablaPhiy*v + alpha^2*(dx(nablaPhiy)*dx(v)+dy(nablaPhiy)*dy(v)))
                        -int2d(Th)(dy(phi)*v);

gradxPhi;
gradyPhi;

LaplPhi = dx(nablaPhix) + dy(nablaPhiy);

w = 1/(1+abs(phi)^2*abs(LaplPhi)^2);

/* 
- Calculate + alphaReg gradient of signed distance
- Calculate laplacian of signed distance
- w = 1/(1 + |dOm|^q |lapl|^r)         q=r=2?
- solve uTerm
- regularization of the shape derivative
 */

fespace Vh2(Th2,P1);
Vh2 u2, v2, g2;

problem uTerm(u2,v2) = int1d(Th2,lsLabel)(u2*v2) + int2d(Th2)(w*(nablaPhix*dx(u2)+nablaPhiy*dy(u2))*(nablaPhix*dx(v2)+nablaPhiy*dy(v2)))
                        -int2d(Th2,rInner)(Jo^(1-p)*(-phi)^(p-1)*v2);

uTerm;

problem velext(g2,v2) = int2d(Th2)(g2*v2 + beta^2*(dx(g2)*dx(v2)+dy(g2)*dy(v2)))
                        -int2d(Th)(-beta*u2*v2);

velext;
g = g2;

sout = "08_Velocity.vtu";
savevtk(sout, Th, g, dataname="Velocity");